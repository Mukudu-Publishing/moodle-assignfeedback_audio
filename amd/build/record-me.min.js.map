{"version":3,"sources":["../src/record-me.js"],"names":["define","$","str","notification","init","posturl","maxduration","gradeid","contextid","navigator","mediaDevices","getUserMedia","notificationok","notificationtitle","stoprecording","stoplistening","maxtimeallowedreached","feedbackremoved","nomediarecordingsupport","nomicrophineallowed","mediasavefailed","medianocapture","get_strings","component","done","strs","nopermission","permissions","query","name","then","result","state","showfeedbackinfo","catch","msg","css","text","processResponse","data","status","alert","message","val","fileref","saveRecordingFile","recordedChunks","length","audioBlob","Blob","type","audiotype","fd","FormData","append","ajax","method","contentType","processData","dataType","error","success","audio","mediaRecorder","cliplength","startbtn","document","getElementsByName","disabled","stopbtn","listenbtn","deletebtn","click","stream","MediaRecorder","mimeType","addEventListener","e","size","push","start","stop","src","pause","textContent","audioUrl","URL","createObjectURL","Audio","play"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/*\n * @package    assignfeedback_audio\n * @copyright  Mukudu Ltd\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n /**\n  * @module assignfeedback_audio/record-me\n  */\ndefine(['jquery', 'core/str', 'core/notification'], function($, str, notification) {\n    return {\n        init: function(posturl, maxduration, gradeid, contextid) {\n            if (navigator.mediaDevices.getUserMedia) {\n                // Get all required strings.\n                var notificationok;\n                var notificationtitle;\n                var stoprecording;\n                var stoplistening;\n                var maxtimeallowedreached;\n                var feedbackremoved;\n                var nomediarecordingsupport;\n                var nomicrophineallowed;\n                var mediasavefailed;\n                var medianocapture;\n                str.get_strings([\n                    {'key' : 'ok', component : 'assignfeedback_audio'},\n                    {'key' : 'pluginname', component : 'assignfeedback_audio'},\n                    {'key' : 'stoprecordingprompt', component : 'assignfeedback_audio'},\n                    {'key' : 'stoplisteningprompt', component : 'assignfeedback_audio'},\n                    {'key' : 'maxtimeallowedreached', component : 'assignfeedback_audio'},\n                    {'key' : 'feedbackremoved', component : 'assignfeedback_audio'},\n                    {'key' : 'nomediarecordingsupport', component : 'assignfeedback_audio'},\n                    {'key' : 'nomicrophineallowed', component : 'assignfeedback_audio'},\n                    {'key' : 'mediasavefailed', component : 'assignfeedback_audio'},\n                    {'key' : 'medianocapture', component : 'assignfeedback_audio'}\n                ]).done(function(strs) {\n                    notificationok = strs[0];\n                    notificationtitle = strs[0];\n                    stoprecording = strs[2];\n                    stoplistening = strs[3];\n                    maxtimeallowedreached = strs[4];\n                    feedbackremoved = strs[5];\n                    nomediarecordingsupport = strs[6];\n                    nomicrophineallowed = strs[7];\n                    mediasavefailed = strs[8];\n                    medianocapture = strs[9];\n                });\n\n                var nopermission = false;\n                // Check permissions - not supported by all browsers - so we ignore those.\n                navigator.permissions.query({name:'microphone'})\n                    .then(function(result) {\n                        if (result && result.state == 'denied') {\n                            nopermission = true;\n                            showfeedbackinfo(nomicrophineallowed);\n                        }\n                     })\n                     .catch(function () {\n                     });\n\n                var showfeedbackinfo = function(msg) {\n                    $(\".feedbackinfoarea\").css('display', 'block');\n                    $(\".feedbackinfoarea\").text(msg);\n                };\n\n                var processResponse = function(data) {\n                    if (data.status == 'error') {\n                        notification.alert(notificationtitle, data.message, notificationok) ;\n                    } else {\n                        $(\"#id_fileref\").val(data.fileref);\n                    }\n                };\n\n                var saveRecordingFile = function() {\n                    if (recordedChunks.length > 0) {\n                        audioBlob = new Blob(recordedChunks, {type: audiotype});\n                        // Send file to server.\n                        var fd = new FormData();\n                        fd.append('action', 'save');\n                        fd.append('audiofile', audioBlob);\n                        fd.append('gradeid', gradeid);\n                        fd.append('contextid', contextid);\n                        $.ajax(posturl, {\n                            method: 'POST',\n                            contentType: false,\n                            processData: false,\n                            dataType: 'json',\n                            data: fd,\n                            error: function() {\n                                notification.alert(notificationtitle, mediasavefailed, notificationok) ;\n                            },\n                            success: processResponse\n                        });\n                    } else {\n                         notification.alert(notificationtitle, medianocapture, notificationok) ;\n                    }\n                };\n                var recordedChunks = [];\n                var audiotype = 'audio/webm';\n                var audioBlob;\n                var audio;\n                var mediaRecorder;\n                var cliplength = 15;    // Seconds\n                // Arrgghhhh!!!!  For some reason .prop() and .attr() not working.\n                var startbtn = document.getElementsByName(\"startbtn\")[0];\n                if (!nopermission) {\n                    startbtn.disabled = false;\n                }\n                var stopbtn = document.getElementsByName(\"stopbtn\")[0];\n                var listenbtn = document.getElementsByName(\"listenbtn\")[0];\n                var deletebtn = document.getElementsByName(\"deletebtn\")[0];\n\n                $(\".startbtn\").click(function() {\n                    startbtn.disabled = true;\n                    stopbtn.disabled = false;\n                    listenbtn.disabled = true;\n                    deletebtn.disabled = true;\n                    if ( recordedChunks.length > 0 ) {\n                        recordedChunks = [];\n                    }\n                    // start recording.\n                    navigator.mediaDevices.getUserMedia({ audio: true })\n                        .then(function(stream) {\n                            mediaRecorder = new MediaRecorder(stream, {mimeType: audiotype});\n                            mediaRecorder.addEventListener('dataavailable', function(e) {\n                                if (e.data.size > 0) {\n                                    recordedChunks.push(e.data);\n                                    // Check length of clip - each chunk is 15 secords\n                                    if (recordedChunks.length >= (maxduration/cliplength)) {\n                                        notification.alert(notificationtitle, maxtimeallowedreached, notificationok) ;\n                                        $(\".stopbtn\").click();\n                                    }\n                                }\n                            });\n                            mediaRecorder.addEventListener('stop', saveRecordingFile);\n                            mediaRecorder.start(1000 * cliplength);    //Every 15 seconds\n                          });\n                });\n\n                $(\".stopbtn\").click(function() {\n                    stopbtn.disabled = true;\n                    startbtn.disabled = false;\n                    listenbtn.disabled = false;\n                    deletebtn.disabled = false;\n                    if (mediaRecorder.state == 'recording') {\n                        mediaRecorder.stop();\n                    } else {                // we are listening\n                        if (audio.src) {\n                            audio.pause();\n                        }\n                    }\n                    // Stop recording.\n                    stopbtn.textContent = stoprecording;\n                });\n\n                $(\".listenbtn\").click(function() {\n                    listenbtn.disabled = true;\n                    stopbtn.disabled = false;\n                    startbtn.disabled = true;\n                    deletebtn.disabled = true;\n                    stopbtn.textContent = stoplistening;\n                    // Listen recording\n                    var audioUrl = URL.createObjectURL(audioBlob);\n                    audio = new Audio(audioUrl);\n                    audio.addEventListener(\"canplaythrough\", function() {\n                        /* the audio is now playable; play it if permissions allow */\n                        audio.play();\n                    });\n                    audio.addEventListener(\"ended\", function() {\n                        $(\".stopbtn\").click();\n                    });\n                });\n\n                $(\".deletebtn\").click(function() {\n                    startbtn.disabled = false;\n                    listenbtn.disabled = true;\n                    stopbtn.disabled = true;\n                    deletebtn.disabled = true;\n                    // Delete the file and the clip;\n                    recordedChunks = [];\n                    audioBlob = null;\n                    $(\"#id_fileref\").val('');\n                    notification.alert(notificationtitle, feedbackremoved, notificationok) ;\n                });\n            } else {\n                showfeedbackinfo(nomediarecordingsupport);\n            }\n        }\n    };\n});\n"],"file":"record-me.min.js"}